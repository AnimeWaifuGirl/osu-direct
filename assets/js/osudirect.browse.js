$(document).ready(()=>{$('#pageScrollerBottom').addClass('shown');const queryParams=parseQueryParams();if("mode"in queryParams){const modes=queryParams.mode.split(",");for(let mode of modes){const dataMode=$(`[data-mode="${mode}"]`);if(dataMode){dataMode.attr("checked",true);dataMode.prop("checked",true);}}}
if("status"in queryParams){const statuses=queryParams.status.split(",");for(let status of statuses){const dataStatus=$(`[data-status="${status}"]`);if(dataStatus){dataStatus.attr("checked",true);dataStatus.prop("checked",true);}}}
if("query"in queryParams){const query=queryParams.query;$("#filter-query").val(query);}
let page=1;let lastScrollPos;let loading=false;let lastResultReached=false;const beatmapList=$("#beatmapList");const loadingIndicator=$("#loading");const colors=[];const rainbow=new Rainbow();rainbow.setSpectrum('#AAAAAA','#4698C4','#4BC6A6','#A3BD4F','#C07E5A','#BC476A','#954496','#5253AA','#1D1D6B','#0E1113','#000000')
rainbow.setNumberRange(0,1000);for(var i=0;i<1000;i++){colors.push(rainbow.colourAt(i));}
$("#sidepanel-toggle").on("click",()=>{$("#sidepanel").toggleClass("open");});$("#sidepanelClose").on("click",()=>{$("#sidepanel").removeClass("open");});$(".sidepanel__main_dim").on("click",()=>{$("#sidepanel").removeClass("open");});const getDiffColor=(starDiff)=>{starDiff=parseInt(starDiff*100,10);if(starDiff>colors.length)return colors[colors.length-1];if(starDiff<0)return colors[0];return colors[starDiff];}
const addBeatmapCard=(beatmap,div,n)=>{const mainCard=$(`<div class="card animated slideSide" style="overflow: visible; width: 420px; animation-delay: ${0.025*n}s;" />`);const mainCardHeader=$(`<div class="card__container" style="min-height: 12rem; cursor: pointer;" onclick="playBeatmap(${beatmap.ChildrenBeatmaps[0].BeatmapID})" />`);mainCardHeader.append($(`<div class="statusOverlay"><i class="fas ${rankedStatusesIcons[beatmap.RankedStatus]}"></i>${rankedStatuses[beatmap.RankedStatus]}</div>`));mainCardHeader.append($(`<div class="card__image" style="background-image: url('https://assets.ppy.sh/beatmaps/${beatmap.SetID}/covers/cover@2x.jpg'); background-position: center;"></div>`));const mainCardHeaderTitle=$('<div class="card__title-container">');const title=$(`<p class="title light mt-0"></h3>`);title.text(beatmap.Title);const subtitle=$(`<span class="subtitle light"></span>`);subtitle.text(beatmap.Artist);mainCardHeaderTitle.append(title);mainCardHeaderTitle.append(subtitle);mainCardHeader.append(mainCardHeaderTitle);mainCard.append(mainCardHeader);const mainCardBody=$('<div class="content u-text-center" style="padding: 0;" />');const beatmapDiffs=$('<div class="beatmapDiffs" />');const childrenBeatmaps=beatmap.ChildrenBeatmaps.sort((a,b)=>{return a.DifficultyRating-b.DifficultyRating;});childrenBeatmaps.forEach((beatmapDiff)=>{const diffColor=getDiffColor(beatmapDiff.DifficultyRating);let modeIcon="mode-osu";switch(beatmapDiff.Mode){case 1:modeIcon="mode-taiko";break;case 2:modeIcon="mode-catch";break;case 3:modeIcon="mode-mania";break;}
const beatmapDiffContainer=$(`<a class="tooltip text-white" href="https://osu.ppy.sh/b/${beatmapDiff.BeatmapID}" data-tooltip="(${beatmapDiff.DifficultyRating}⭐)[${beatmapDiff.DiffName}]" target="_blank"><i class="mode-icon ${modeIcon}" style="background-color: #${diffColor};"></i></a>`);beatmapDiffs.append(beatmapDiffContainer);});mainCardBody.append(beatmapDiffs);mainCard.append(mainCardBody);const actions=$('<div class="card__action-bar u-center py-2" />');actions.append($(`<a href="${apiUrl}/api/d/${beatmap.SetID}" class="btn btn-dark">Download</a>`));if(beatmap.HasVideo)
actions.append($(`<a href="${apiUrl}/api/d/${beatmap.SetID}?noVideo" class="btn btn-dark">Download (no video)</a>`));mainCard.append(actions);const cardFooter=$('<div class="card__footer text-muted content" />');cardFooter.append($(`<div>Mapped by <a class="text-ctp-red" href="https://osu.ppy.sh/u/${beatmap.Creator}" target="_blank">${beatmap.Creator}</a></div>`));switch(beatmap.RankedStatus){case 1:cardFooter.append($(`<div>Ranked at ${beatmap.ApprovedDate}</div>`));break;case 2:cardFooter.append($(`<div>Approved at ${beatmap.ApprovedDate}</div>`));break;case 3:cardFooter.append($(`<div>Qualified at ${beatmap.ApprovedDate}</div>`));break;case 4:cardFooter.append($(`<div>Loved at ${beatmap.ApprovedDate}</div>`));break;default:cardFooter.append($(`<div>Last update at ${beatmap.LastUpdate}</div>`));break;}
mainCard.append(cardFooter);div.append(mainCard);}
const fetchBeatmaps=async(page)=>{if($('#error')){$('#error').remove();}
if($('#no-match')){$('#no-match').remove();}
loadingIndicator.attr('style','');const filtered_modes=[];if($("#filter-mode-osu").is(":checked"))filtered_modes.push(0);if($("#filter-mode-taiko").is(":checked"))filtered_modes.push(1);if($("#filter-mode-catch").is(":checked"))filtered_modes.push(2);if($("#filter-mode-mania").is(":checked"))filtered_modes.push(3);const filtered_status=[];if($("#filter-status-ranked").is(":checked"))filtered_status.push(1);if($("#filter-status-approved").is(":checked"))filtered_status.push(2);if($("#filter-status-qualified").is(":checked"))filtered_status.push(3);if($("#filter-status-loved").is(":checked"))filtered_status.push(4);if($("#filter-status-pending").is(":checked"))filtered_status.push(0);if($("#filter-status-wip").is(":checked"))filtered_status.push(-1);if($("#filter-status-graveyard").is(":checked"))filtered_status.push(-2);const queryParams=new URLSearchParams({amount:20,offset:page<=0?0:(20*(page-1)),q:$("#filter-query").val(),mode:filtered_modes.join(","),status:filtered_status.join(","),});try{const beatmapsResult=await fetch(`${apiUrl}/api/search?`+queryParams);if(!beatmapsResult){lastResultReached=true;loadingIndicator.attr('style','display:none !important');const row=$(`<div class="u-flex u-flex-wrap u-justify-center u-gap-2 u-round-xs text-white u-text-center" id="error">`);const mainCard=$(`<div class="card bg-gray-900 animated slideUp">`);const cardContent=$(`<div class="content u-text-center pt-3 px-5" style="min-width: 450px; max-width: 650px;">`);const cardLogo=$(`<i class="fa fa-bomb fa-2x w-10 fa-wrapper text-ctp-red bg-ctp-surface0 p-3 u-center u-round-full"></i>`);cardContent.append(cardLogo);const cardTitle=$(`<p id="projectname" class="title text-lg text-white mt-2 mb-0">Oh uhh..</p>`);cardContent.append(cardTitle);const cardText=$(`<p class="text-light">Failed to fetch beatmap results...</p>`);cardContent.append(cardText);const retryButton=$("<a class='btn btn-dark'>Retry</a>");cardContent.append(retryButton);retryButton.on("click",async()=>{beatmapList.empty();lastResultReached=false;page=1;await fetchBeatmaps(page);page++;});mainCard.append(cardContent);row.append(mainCard);$('#centerRow').append(row);console.error(e);}
const beatmaps=await beatmapsResult.json();if(beatmaps.length<=0){if(page<=1){loadingIndicator.attr('style','display:none !important');const row=$(`<div class="u-flex u-flex-wrap u-justify-center u-gap-2 u-round-xs text-white u-text-center" id="no-matches">`);const mainCard=$(`<div class="card bg-gray-900 animated slideUp">`);const cardContent=$(`<div class="content u-text-center pt-3 px-5" style="min-width: 450px; max-width: 650px;">`);const cardLogo=$(`<i class="far fa-sad-tear fa-2x w-10 fa-wrapper text-ctp-red bg-ctp-surface0 p-3 u-center u-round-full"></i>`);cardContent.append(cardLogo);const cardTitle=$(`<p id="projectname" class="title text-lg text-white mt-2 mb-0">No results found :c</p>`);cardContent.append(cardTitle);const cardText=$(`<p class="text-light">We could not find any maps matching your criterias...</p>`);cardContent.append(cardText);mainCard.append(cardContent);row.append(mainCard);$('#centerRow').append(row);}
lastResultReached=true;}
for(const beatmap of beatmaps){addBeatmapCard(beatmap,beatmapList,beatmaps.indexOf(beatmap));}
loadingIndicator.attr('style','display:none !important');}catch(e){lastResultReached=true;loadingIndicator.attr('style','display:none !important');const row=$(`<div class="u-flex u-flex-wrap u-justify-center u-gap-2 u-round-xs text-white u-text-center" id="error">`);const mainCard=$(`<div class="card bg-gray-900 animated slideUp">`);const cardContent=$(`<div class="content u-text-center pt-3 px-5" style="min-width: 450px; max-width: 650px;">`);const cardLogo=$(`<i class="far fa-bomb fa-2x w-10 fa-wrapper text-ctp-red bg-ctp-surface0 p-3 u-center u-round-full"></i>`);cardContent.append(cardLogo);const cardTitle=$(`<p id="projectname" class="title text-lg text-white mt-2 mb-0">Oh uhh..</p>`);cardContent.append(cardTitle);const cardText=$(`<p class="text-light">Failed to fetch beatmap results...</p>`);cardContent.append(cardText);const retryButton=$("<a class='btn btn-dark'>Retry</a>");cardContent.append(retryButton);retryButton.on("click",async()=>{beatmapList.empty();lastResultReached=false;page=1;await fetchBeatmaps(page);page++;});mainCard.append(cardContent);row.append(mainCard);$('#centerRow').append(row);console.error(e);}}
setTimeout(async()=>{await(fetchBeatmaps(page));page++;$("#filter-apply").on("click",async()=>{updatePath();beatmapList.empty();lastResultReached=false;page=1;$("#sidepanel").removeClass("open");window.scrollTo({top:0});await fetchBeatmaps(page);page++;});window.onscroll=async function(){let totalPageHeight=beatmapList.offset().top+beatmapList.outerHeight();let scrollPoint=window.scrollY+window.innerHeight;if(scrollPoint==lastScrollPos)return;lastScrollPos=scrollPoint;if(scrollPoint>=totalPageHeight+100&&!loading&&!lastResultReached){loading=true;await fetchBeatmaps(page);page++;loading=false;}};},10);});function updatePath(){if(history.pushState){var newurl=window.location.protocol+"//"+window.location.host+window.location.pathname;const filtered_modes=[];if($("#filter-mode-osu").is(":checked"))filtered_modes.push(0);if($("#filter-mode-taiko").is(":checked"))filtered_modes.push(1);if($("#filter-mode-catch").is(":checked"))filtered_modes.push(2);if($("#filter-mode-mania").is(":checked"))filtered_modes.push(3);const filtered_status=[];if($("#filter-status-ranked").is(":checked"))filtered_status.push(1);if($("#filter-status-approved").is(":checked"))filtered_status.push(2);if($("#filter-status-qualified").is(":checked"))filtered_status.push(3);if($("#filter-status-loved").is(":checked"))filtered_status.push(4);if($("#filter-status-pending").is(":checked"))filtered_status.push(0);if($("#filter-status-wip").is(":checked"))filtered_status.push(-1);if($("#filter-status-graveyard").is(":checked"))filtered_status.push(-2);let queryParams="";if(filtered_modes.length>0)
queryParams="?mode="+filtered_modes.join(",");if(filtered_status.length>0)
queryParams+=`${queryParams.length<=0?"?":"&"}status=`+filtered_status.join(",");if($("#filter-query").val().length>0)
queryParams+=`${queryParams.length<=0?"?":"&"}query=`+encodeURIComponent($("#filter-query").val());window.history.pushState({path:newurl+queryParams},'',newurl+queryParams);}}
let audioLoading=false;let currentAudio;let currentAudioTime;let currentAudioDuration;const playerContainer=$('#musicplayer-container');const playerCover=$('#musicplayer-cover');const playerTime=$('#musicplayer-time');const playerProgress=$('#musicplayer-progress');const playerArtist=$('#musicplayer-artist');const playerTitle=$('#musicplayer-title');const playerPlayPause=$('#musicplayer-playpause');const playerBackward=$('#musicplayer-backward');const playerForward=$('#musicplayer-forward');$('.musicplayer-close').on('click',()=>{if(currentAudio){currentAudio.pause();playerContainer.removeClass('show');currentAudio=null;}});playerBackward.on('click',()=>{if(currentAudio){currentAudio.currentTime=Math.max(0,currentAudio.currentTime-5);}});playerForward.on('click',()=>{if(currentAudio){currentAudio.currentTime=Math.min(currentAudioDuration,currentAudio.currentTime+5);if(currentAudio.currentTime+5>currentAudioDuration){currentAudio.pause();playerContainer.removeClass('show');currentAudio=null;}}});playerPlayPause.on('click',()=>{if(currentAudio){if(currentAudio.paused){currentAudio.play();playerPlayPause.find("i").removeClass("fa-play");playerPlayPause.find("i").addClass("fa-pause");}else{currentAudio.pause();playerPlayPause.find("i").removeClass("fa-pause");playerPlayPause.find("i").addClass("fa-play");}}});async function playBeatmap(beatmapId){if(audioLoading)return;if(currentAudio)currentAudio.pause();audioLoading=true;const beatmapInfo=await fetch(`${apiUrl}/api/b/${beatmapId}?full`);const beatmapInfoJson=await beatmapInfo.json();const headers=await fetch(`${apiUrl}/api/media/audio/${beatmapId}`);let previewStart;if(headers.headers.has('content-previewtime'))
previewStart=parseInt(headers.headers.get('content-previewtime'))/1000;currentAudio=new Audio(`${apiUrl}/api/media/audio/${beatmapId}`);currentAudio.addEventListener("loadeddata",function(){currentAudioDuration=this.duration;playerCover.attr('src',`https://assets.ppy.sh/beatmaps/${beatmapInfoJson.SetID}/covers/list.jpg`);playerArtist.text(beatmapInfoJson.Artist);playerTitle.text(beatmapInfoJson.Title);playerPlayPause.find("i").removeClass("fa-play");playerPlayPause.find("i").addClass("fa-pause");playerContainer.addClass('show');currentAudio.volume=0.4;currentAudio.currentTime=previewStart;currentAudio.play();audioLoading=false;});currentAudio.addEventListener("timeupdate",function(){currentAudioTime=Math.trunc(currentAudio.currentTime);currentAudioDuration=Math.trunc(currentAudio.duration);const audioTime=new Date(currentAudioTime*1000).toISOString().substring(14,19);const audioDuration=new Date(currentAudioDuration*1000).toISOString().substring(14,19);const progress=(currentAudioTime/currentAudioDuration)*100;playerProgress.css('width',`${progress}%`);playerTime.text(`${audioTime} / ${audioDuration}`);});currentAudio.addEventListener("ended",function(){playerContainer.removeClass('show');currentAudio=null;});}